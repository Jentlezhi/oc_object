<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 9.2.1 (458835)"/><meta name="author" content="juntaozhi@163.com"/><meta name="created" content="2019-11-11 13:12:13 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2019-11-20 11:30:46 +0000"/><meta name="content-class" content="yinxiang.markdown"/><title>12. Category</title></head><body><div style="font-size: 14px; margin: 0; padding: 0; width: 100%;"><h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">1. Category的实现原理</h4>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">Category编译之后的底层结构是struct category_t，里面存储着分类的对象方法、类方法、属性、协议信息。<br/>
程序在运行的时候，runtime会将Category的数据，合并到类信息中（类对象、元类对象中）<br/>
底层代码：</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">
每个分类都是一个_category_t类型的结构体：
struct category_t {
    #类名（拓展的类）
    const char *name;
    #类
    classref_t cls;
    #category中所有给类添加的实例方法的列表(instanceMethods)
    struct method_list_t *instanceMethods;
    #category中所有添加的类方法的列表(classMethods)
    struct method_list_t *classMethods;
    #category实现的所有协议的列表(protocols)
    struct protocol_list_t *protocols;
    #category中添加的所有属性(instanceProperties)
    struct property_list_t *instanceProperties;

    method_list_t *methodsForMeta(bool isMeta) {
        if (isMeta) return classMethods;
        else return instanceMethods;
    }

    property_list_t *propertiesForMeta(bool isMeta) {
        if (isMeta) return nil; // classProperties;
        else return instanceProperties;
    }
};

</code></pre>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">static struct /*_method_list_t*/ {
	unsigned int entsize;  // sizeof(struct _objc_method)
	unsigned int method_count;
	struct _objc_method method_list[1];
} _OBJC_$_CATEGORY_INSTANCE_METHODS_Person_$_Eat __attribute__ ((used, section ("__DATA,__objc_const"))) = {
	sizeof(_objc_method),
	1,
	{{(struct objc_selector *)"eat", "v16@0:8", (void *)_I_Person_Eat_eat}}
};

extern "C" __declspec(dllimport) struct _class_t OBJC_CLASS_$_Person;

static struct _category_t _OBJC_$_CATEGORY_Person_$_Eat __attribute__ ((used, section ("__DATA,__objc_const"))) = 
{
	"Person",
	0, // &amp;OBJC_CLASS_$_Person,
	(const struct _method_list_t *)&amp;_OBJC_$_CATEGORY_INSTANCE_METHODS_Person_$_Eat,
	0,
	0,
	0,
};
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">源码：</p>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><a href="https://juejin.im/post/5a9d14856fb9a028e52d5568" style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">从源码解读Category实现原理</a></p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">void _objc_init(void)
{
    static bool initialized = false;
    if (initialized) return;
    initialized = true;
    
    // fixme defer initialization until an objc-using image is found?
    environ_init();
    tls_init();
    static_init();
    lock_init();
    exception_init();

    _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);
}

</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">到真正完成绑定 category 的函数attachCategories中间的函数调用栈是</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">void _objc_init(void);
└── void map_images(...);
    └── void map_images_nolock(...);
        └── void _read_images(...);
            └── void _read_images(...);
                └── static void remethodizeClass(Class cls);
                    └──attachCategories(Class cls, category_list *cats, bool flush_caches);

</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">我们来看一下 attachCategories 源码的简易版：</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">static void 
attachCategories(Class cls, category_list *cats, bool flush_caches)
{
    if (!cats) return;
    
    bool isMeta = cls-&gt;isMetaClass();

    method_list_t **mlists = (method_list_t **)
        malloc(cats-&gt;count * sizeof(*mlists));

    int mcount = 0;
    int i = cats-&gt;count;
    bool fromBundle = NO;
    while (i--) {
        auto&amp; entry = cats-&gt;list[i];

        method_list_t *mlist = entry.cat-&gt;methodsForMeta(isMeta);
        if (mlist) {
            mlists[mcount++] = mlist;
            fromBundle |= entry.hi-&gt;isBundle();
        }
    }

    auto rw = cls-&gt;data();

    prepareMethodLists(cls, mlists, mcount, NO, fromBundle);
    rw-&gt;methods.attachLists(mlists, mcount);
    free(mlists);
    if (flush_caches  &amp;&amp;  mcount &gt; 0) flushCaches(cls);
}

</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">从上面的代码可以看出，增加方法的操作实际是分配一个大的实例方法列表<br/>
method_list_t **mlists = (method_list_t **) malloc(cats-&gt;count * sizeof(*mlists)); 再通过 for 循环将category中的方法列表填入这个大的列表，最后交给 rw-&gt;methods.attachLists(mlists, mcount);将方法列表增加到类的方法列表上去（列表前面）。其他的属性添加与此类似</p>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">我们再看一段 attachLists的源码</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">void attachLists(List* const * addedLists, uint32_t addedCount) {
 if (hasArray()) {
        
        //旧的方法列表的长度
        uint32_t oldCount = array()-&gt;count;
        
        //新的方法列表的长度
        uint32_t newCount = oldCount + addedCount;
        
        setArray((array_t *)realloc(array(), array_t::byteSize(newCount)));
        array()-&gt;count = newCount;
        
        //从addedCount的偏移量添加旧的方法列表
        memmove(array()-&gt;lists + addedCount, array()-&gt;lists, 
                oldCount * sizeof(array()-&gt;lists[0]));
        //从开始添加新方法列表
        memcpy(array()-&gt;lists, addedLists, 
               addedCount * sizeof(array()-&gt;lists[0]));
        }
}

</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">从上面的代码也验证了我们上面所说的，同名的方法是覆盖而不是替换，category的方法被放到了新方法列表的前面</p>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">2. Category和Class Extension的区别是什么？</h4>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">Class Extension在编译的时候，它的数据就已经包含在类信息中<br/>
Category是在运行时，才会将数据合并到类信息中</p>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">3. load调用原理</h4>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><img src="12.%20Category.resources/WeWork%20Helper20191115101119.png" height="1352" width="1740"/></p>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><img src="12.%20Category.resources/WeWork%20Helper20191115113457.png" height="598" width="1638"/></p>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">4. load与类方法调用区别</h4>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">load方法底层是通过函数指针直接调用，类方法通过objc_messageSend消息机制调用。</p>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">5. 面试题</h4>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">5.1 Category有load方法吗？ load方法是什么时候调用？load方法能继承吗？</h5>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">有load方法</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">load方法在runtime加载类、分类的时候调用</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">load方法可以继承，但是一般情况下我们不会主动调用load方法，都是让系统自动调用。</li>
</ul>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">5.2 load、initialize方法的区别是什么？它们在Category中的调用顺序是什么？以及出现继承时它们之间的调用过程是什么？</h5>
<h6 style="line-height: 160%; box-sizing: content-box; font-size: 13px; color: #333;">load、initialize方法的区别是什么</h6>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">调用方式</li>
</ul>
<ol style="line-height: 160%; box-sizing: content-box; display: block; padding-left: 30px; margin: 6px 0 10px; color: #333; list-style-type: decimal;">
<li style="line-height: 160%; box-sizing: content-box;">load是根据函数地址直接调用</li>
<li style="line-height: 160%; box-sizing: content-box;">initialize是通过objc_msgSend调用</li>
</ol>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">调用时刻</li>
</ul>
<ol style="line-height: 160%; box-sizing: content-box; display: block; padding-left: 30px; margin: 6px 0 10px; color: #333; list-style-type: decimal;">
<li style="line-height: 160%; box-sizing: content-box;">load是在runtime加载分类的时候调用（只会调用一次）</li>
<li style="line-height: 160%; box-sizing: content-box;">initialize是类第一次接收到消息的时候调用，每一个类只会initialize一次（父类的initialize方法可能会被调用多次）</li>
</ol>
<h6 style="line-height: 160%; box-sizing: content-box; font-size: 13px; color: #333;">load、initialize方法的调用顺序</h6>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">load</li>
</ul>
<ol style="line-height: 160%; box-sizing: content-box; display: block; padding-left: 30px; margin: 6px 0 10px; color: #333; list-style-type: decimal;">
<li style="line-height: 160%; box-sizing: content-box;">先调用类的load<br/>
a.先编译的类，优先调用load<br/>
b.调用子类的load之前，会先调用父类的load</li>
<li style="line-height: 160%; box-sizing: content-box;">再调用分类的load<br/>
a.先编译的分类，优先调用load</li>
</ol>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">initialize</li>
</ul>
<ol style="line-height: 160%; box-sizing: content-box; display: block; padding-left: 30px; margin: 6px 0 10px; color: #333; list-style-type: decimal;">
<li style="line-height: 160%; box-sizing: content-box;">先初始化父类</li>
<li style="line-height: 160%; box-sizing: content-box;">再初始化子类（可能最终调用父类的initialize方法）</li>
</ol>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">6.1 Category能否直接添加成员变量？如果可以，如何给Category添加成员变量？</h5>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">不能直接给Category添加成员变量，但是可以间接实现分类有成员变量的效果。</p>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">分类的底层结构决定了它不能直接添加成员变量，因为没有数组来存放成员变量（注意区分成员变量和属性的区别），而从类的底层结构中可以看出ivars（struct objc_ivar_list * _Nullable ivars OBJC2_UNAVAILABLE;）是存放成员变量的。</p>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">从分类的底层实现看出，其中struct property_list_t *instanceProperties，分类是可以添加属性的。</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">
每个分类都是一个_category_t类型的结构体：
struct category_t {
    #类名（拓展的类）
    const char *name;
    #类
    classref_t cls;
    #category中所有给类添加的实例方法的列表(instanceMethods)
    struct method_list_t *instanceMethods;
    #category中所有添加的类方法的列表(classMethods)
    struct method_list_t *classMethods;
    #category实现的所有协议的列表(protocols)
    struct protocol_list_t *protocols;
    #category中添加的所有属性(instanceProperties)
    struct property_list_t *instanceProperties;

    method_list_t *methodsForMeta(bool isMeta) {
        if (isMeta) return classMethods;
        else return instanceMethods;
    }

    property_list_t *propertiesForMeta(bool isMeta) {
        if (isMeta) return nil; // classProperties;
        else return instanceProperties;
    }
};

</code></pre>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">6.2 完善使用字典给Category添加关联对象</h5>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">///方法二：用字典建立self与值的关系
NSMutableDictionary *weights_;

- (void)setWeight:(float)weight {
    
    NSString *key = [NSString stringWithFormat:@"%p",self];
    weights_[key] = @(weight);
}

- (float)weight {
    
    NSString *key = [NSString stringWithFormat:@"%p",self];
    return [weights_[key] floatValue];
}

</code></pre>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">存在问题：</p>
</blockquote>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">内存问题（weights_全局），可能导致内存泄漏问题</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">线程安全问题</li>
</ul>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">6.3 Category关联对象</h5>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">#import "Student+Test.h"
#import &lt;objc/runtime.h&gt;

@implementation Student (Test)

///key的写法1,没有值，导致多个关联对象时候，无法获取到正确的值。
//const void *StuNameKey;
//const void *StuGenderKey;

///key的写法2,外界通过extern const void *StuNameKey;可以随意修改值
///void *则为“无类型指针”，void *可以指向任何类型的数据。
//const void *StuNameKey = &amp;StuNameKey;
//const void *StuGenderKey = &amp;StuGenderKey;

///key的写法3,static确保只能内部使用，外界不得修改
//static const void *StuNameKey = &amp;StuNameKey;
//static const void *StuGenderKey = &amp;StuGenderKey;

///key的写法4,const void * _Nonnull key，说明需要一个地址（void *）值，所以没有必要给赋值，通过&amp;StuNameKey访问地址即可
//static const void *StuNameKey;
static const void *StuGenderKey;

///key的写法5,key传一个字符串（@"name",直接写出来的字符串是放在内存中的常量区，它的地址是不会变的）,key实际上就是一个地址
#define StuNameKey @"name"
//objc_setAssociatedObject(self, StuNameKey, name, OBJC_ASSOCIATION_COPY_NONATOMIC);
//return objc_getAssociatedObject(self, StuNameKey);

///key的写法6,key传@selector(name):::推荐
//objc_setAssociatedObject(self, @selector(name), name, OBJC_ASSOCIATION_COPY_NONATOMIC);
//return objc_getAssociatedObject(self, @selector(name));

- (void)setName:(NSString *)name {
//NSLog(@"%@:StuNameKey:%p",NSStringFromSelector(_cmd),StuNameKey);
/*
 objc_setAssociatedObject(id _Nonnull object, const void * _Nonnull key,
 id _Nullable value, objc_AssociationPolicy policy)
 object:关联的源对象
 key:关联对象的key，传空会清除关联
 policy: 关联策略
 */
    
    
    objc_setAssociatedObject(self, StuNameKey, name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}

- (NSString *)name {
    
    return objc_getAssociatedObject(self, StuNameKey);
}

- (void)setGender:(NSString *)gender {
    
    objc_setAssociatedObject(self, &amp;StuGenderKey, gender, OBJC_ASSOCIATION_COPY_NONATOMIC);
}

- (NSString *)gender {
    
    return objc_getAssociatedObject(self, &amp;StuGenderKey);
}

@end

</code></pre>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">推荐写法：</li>
</ul>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">- (void)setName:(NSString *)name {
//NSLog(@"%@:StuNameKey:%p",NSStringFromSelector(_cmd),StuNameKey);
/*
 objc_setAssociatedObject(id _Nonnull object, const void * _Nonnull key,
 id _Nullable value, objc_AssociationPolicy policy)
 object:关联的源对象
 key:关联对象的key，传空会清除关联
 policy: 关联策略
 */
    
    
    objc_setAssociatedObject(self, @selector(name), name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}

- (NSString *)name {
    
    return objc_getAssociatedObject(self, @selector(name));
}
</code></pre>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">6.4 Category关联对象的原理</h5>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">void objc_setAssociatedObject(id object, const void *key, id value, objc_AssociationPolicy policy) {
    _object_set_associative_reference(object, (void *)key, value, policy);
}
</code></pre>
</div><center style="display:none !important;visibility:collapse !important;height:0 !important;white-space:nowrap;width:100%;overflow:hidden">%23%23%23%23%201.%20Category%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%0A%0A%0ACategory%E7%BC%96%E8%AF%91%E4%B9%8B%E5%90%8E%E7%9A%84%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84%E6%98%AFstruct%20category_t%EF%BC%8C%E9%87%8C%E9%9D%A2%E5%AD%98%E5%82%A8%E7%9D%80%E5%88%86%E7%B1%BB%E7%9A%84%E5%AF%B9%E8%B1%A1%E6%96%B9%E6%B3%95%E3%80%81%E7%B1%BB%E6%96%B9%E6%B3%95%E3%80%81%E5%B1%9E%E6%80%A7%E3%80%81%E5%8D%8F%E8%AE%AE%E4%BF%A1%E6%81%AF%E3%80%82%0A%E7%A8%8B%E5%BA%8F%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8Cruntime%E4%BC%9A%E5%B0%86Category%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%90%88%E5%B9%B6%E5%88%B0%E7%B1%BB%E4%BF%A1%E6%81%AF%E4%B8%AD%EF%BC%88%E7%B1%BB%E5%AF%B9%E8%B1%A1%E3%80%81%E5%85%83%E7%B1%BB%E5%AF%B9%E8%B1%A1%E4%B8%AD%EF%BC%89%0A%E5%BA%95%E5%B1%82%E4%BB%A3%E7%A0%81%EF%BC%9A%0A%0A%60%60%60%0A%0A%E6%AF%8F%E4%B8%AA%E5%88%86%E7%B1%BB%E9%83%BD%E6%98%AF%E4%B8%80%E4%B8%AA_category_t%E7%B1%BB%E5%9E%8B%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93%EF%BC%9A%0Astruct%20category_t%20%7B%0A%20%20%20%20%23%E7%B1%BB%E5%90%8D%EF%BC%88%E6%8B%93%E5%B1%95%E7%9A%84%E7%B1%BB%EF%BC%89%0A%20%20%20%20const%20char%20*name%3B%0A%20%20%20%20%23%E7%B1%BB%0A%20%20%20%20classref_t%20cls%3B%0A%20%20%20%20%23category%E4%B8%AD%E6%89%80%E6%9C%89%E7%BB%99%E7%B1%BB%E6%B7%BB%E5%8A%A0%E7%9A%84%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%95%E7%9A%84%E5%88%97%E8%A1%A8(instanceMethods)%0A%20%20%20%20struct%20method_list_t%20*instanceMethods%3B%0A%20%20%20%20%23category%E4%B8%AD%E6%89%80%E6%9C%89%E6%B7%BB%E5%8A%A0%E7%9A%84%E7%B1%BB%E6%96%B9%E6%B3%95%E7%9A%84%E5%88%97%E8%A1%A8(classMethods)%0A%20%20%20%20struct%20method_list_t%20*classMethods%3B%0A%20%20%20%20%23category%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%89%80%E6%9C%89%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%88%97%E8%A1%A8(protocols)%0A%20%20%20%20struct%20protocol_list_t%20*protocols%3B%0A%20%20%20%20%23category%E4%B8%AD%E6%B7%BB%E5%8A%A0%E7%9A%84%E6%89%80%E6%9C%89%E5%B1%9E%E6%80%A7(instanceProperties)%0A%20%20%20%20struct%20property_list_t%20*instanceProperties%3B%0A%0A%20%20%20%20method_list_t%20*methodsForMeta(bool%20isMeta)%20%7B%0A%20%20%20%20%20%20%20%20if%20(isMeta)%20return%20classMethods%3B%0A%20%20%20%20%20%20%20%20else%20return%20instanceMethods%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20property_list_t%20*propertiesForMeta(bool%20isMeta)%20%7B%0A%20%20%20%20%20%20%20%20if%20(isMeta)%20return%20nil%3B%20%2F%2F%20classProperties%3B%0A%20%20%20%20%20%20%20%20else%20return%20instanceProperties%3B%0A%20%20%20%20%7D%0A%7D%3B%0A%0A%60%60%60%0A%0A%0A%60%60%60%0Astatic%20struct%20%2F*_method_list_t*%2F%20%7B%0A%09unsigned%20int%20entsize%3B%20%20%2F%2F%20sizeof(struct%20_objc_method)%0A%09unsigned%20int%20method_count%3B%0A%09struct%20_objc_method%20method_list%5B1%5D%3B%0A%7D%20_OBJC_%24_CATEGORY_INSTANCE_METHODS_Person_%24_Eat%20__attribute__%20((used%2C%20section%20(%22__DATA%2C__objc_const%22)))%20%3D%20%7B%0A%09sizeof(_objc_method)%2C%0A%091%2C%0A%09%7B%7B(struct%20objc_selector%20*)%22eat%22%2C%20%22v16%400%3A8%22%2C%20(void%20*)_I_Person_Eat_eat%7D%7D%0A%7D%3B%0A%0Aextern%20%22C%22%20__declspec(dllimport)%20struct%20_class_t%20OBJC_CLASS_%24_Person%3B%0A%0Astatic%20struct%20_category_t%20_OBJC_%24_CATEGORY_Person_%24_Eat%20__attribute__%20((used%2C%20section%20(%22__DATA%2C__objc_const%22)))%20%3D%20%0A%7B%0A%09%22Person%22%2C%0A%090%2C%20%2F%2F%20%26OBJC_CLASS_%24_Person%2C%0A%09(const%20struct%20_method_list_t%20*)%26_OBJC_%24_CATEGORY_INSTANCE_METHODS_Person_%24_Eat%2C%0A%090%2C%0A%090%2C%0A%090%2C%0A%7D%3B%0A%60%60%60%0A%0A%0A%E6%BA%90%E7%A0%81%EF%BC%9A%0A%0A%5B%E4%BB%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BBCategory%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%5D(https%3A%2F%2Fjuejin.im%2Fpost%2F5a9d14856fb9a028e52d5568)%0A%0A%60%60%60%0Avoid%20_objc_init(void)%0A%7B%0A%20%20%20%20static%20bool%20initialized%20%3D%20false%3B%0A%20%20%20%20if%20(initialized)%20return%3B%0A%20%20%20%20initialized%20%3D%20true%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20fixme%20defer%20initialization%20until%20an%20objc-using%20image%20is%20found%3F%0A%20%20%20%20environ_init()%3B%0A%20%20%20%20tls_init()%3B%0A%20%20%20%20static_init()%3B%0A%20%20%20%20lock_init()%3B%0A%20%20%20%20exception_init()%3B%0A%0A%20%20%20%20_dyld_objc_notify_register(%26map_images%2C%20load_images%2C%20unmap_image)%3B%0A%7D%0A%0A%60%60%60%0A%0A%E5%88%B0%E7%9C%9F%E6%AD%A3%E5%AE%8C%E6%88%90%E7%BB%91%E5%AE%9A%20category%20%E7%9A%84%E5%87%BD%E6%95%B0attachCategories%E4%B8%AD%E9%97%B4%E7%9A%84%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%A0%88%E6%98%AF%0A%0A%60%60%60%0Avoid%20_objc_init(void)%3B%0A%E2%94%94%E2%94%80%E2%94%80%20void%20map_images(...)%3B%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20void%20map_images_nolock(...)%3B%0A%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20void%20_read_images(...)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20void%20_read_images(...)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20static%20void%20remethodizeClass(Class%20cls)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80attachCategories(Class%20cls%2C%20category_list%20*cats%2C%20bool%20flush_caches)%3B%0A%0A%60%60%60%0A%0A%E6%88%91%E4%BB%AC%E6%9D%A5%E7%9C%8B%E4%B8%80%E4%B8%8B%20attachCategories%20%E6%BA%90%E7%A0%81%E7%9A%84%E7%AE%80%E6%98%93%E7%89%88%EF%BC%9A%0A%0A%60%60%60%0Astatic%20void%20%0AattachCategories(Class%20cls%2C%20category_list%20*cats%2C%20bool%20flush_caches)%0A%7B%0A%20%20%20%20if%20(!cats)%20return%3B%0A%20%20%20%20%0A%20%20%20%20bool%20isMeta%20%3D%20cls-%3EisMetaClass()%3B%0A%0A%20%20%20%20method_list_t%20**mlists%20%3D%20(method_list_t%20**)%0A%20%20%20%20%20%20%20%20malloc(cats-%3Ecount%20*%20sizeof(*mlists))%3B%0A%0A%20%20%20%20int%20mcount%20%3D%200%3B%0A%20%20%20%20int%20i%20%3D%20cats-%3Ecount%3B%0A%20%20%20%20bool%20fromBundle%20%3D%20NO%3B%0A%20%20%20%20while%20(i--)%20%7B%0A%20%20%20%20%20%20%20%20auto%26%20entry%20%3D%20cats-%3Elist%5Bi%5D%3B%0A%0A%20%20%20%20%20%20%20%20method_list_t%20*mlist%20%3D%20entry.cat-%3EmethodsForMeta(isMeta)%3B%0A%20%20%20%20%20%20%20%20if%20(mlist)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20mlists%5Bmcount%2B%2B%5D%20%3D%20mlist%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20fromBundle%20%7C%3D%20entry.hi-%3EisBundle()%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%0A%20%20%20%20auto%20rw%20%3D%20cls-%3Edata()%3B%0A%0A%20%20%20%20prepareMethodLists(cls%2C%20mlists%2C%20mcount%2C%20NO%2C%20fromBundle)%3B%0A%20%20%20%20rw-%3Emethods.attachLists(mlists%2C%20mcount)%3B%0A%20%20%20%20free(mlists)%3B%0A%20%20%20%20if%20(flush_caches%20%20%26%26%20%20mcount%20%3E%200)%20flushCaches(cls)%3B%0A%7D%0A%0A%60%60%60%0A%0A%E4%BB%8E%E4%B8%8A%E9%9D%A2%E7%9A%84%E4%BB%A3%E7%A0%81%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%87%BA%EF%BC%8C%E5%A2%9E%E5%8A%A0%E6%96%B9%E6%B3%95%E7%9A%84%E6%93%8D%E4%BD%9C%E5%AE%9E%E9%99%85%E6%98%AF%E5%88%86%E9%85%8D%E4%B8%80%E4%B8%AA%E5%A4%A7%E7%9A%84%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%95%E5%88%97%E8%A1%A8%0Amethod_list_t%20**mlists%20%3D%20(method_list_t%20**)%20malloc(cats-%3Ecount%20*%20sizeof(*mlists))%3B%20%E5%86%8D%E9%80%9A%E8%BF%87%20for%20%E5%BE%AA%E7%8E%AF%E5%B0%86category%E4%B8%AD%E7%9A%84%E6%96%B9%E6%B3%95%E5%88%97%E8%A1%A8%E5%A1%AB%E5%85%A5%E8%BF%99%E4%B8%AA%E5%A4%A7%E7%9A%84%E5%88%97%E8%A1%A8%EF%BC%8C%E6%9C%80%E5%90%8E%E4%BA%A4%E7%BB%99%20rw-%3Emethods.attachLists(mlists%2C%20mcount)%3B%E5%B0%86%E6%96%B9%E6%B3%95%E5%88%97%E8%A1%A8%E5%A2%9E%E5%8A%A0%E5%88%B0%E7%B1%BB%E7%9A%84%E6%96%B9%E6%B3%95%E5%88%97%E8%A1%A8%E4%B8%8A%E5%8E%BB%EF%BC%88%E5%88%97%E8%A1%A8%E5%89%8D%E9%9D%A2%EF%BC%89%E3%80%82%E5%85%B6%E4%BB%96%E7%9A%84%E5%B1%9E%E6%80%A7%E6%B7%BB%E5%8A%A0%E4%B8%8E%E6%AD%A4%E7%B1%BB%E4%BC%BC%0A%0A%E6%88%91%E4%BB%AC%E5%86%8D%E7%9C%8B%E4%B8%80%E6%AE%B5%20attachLists%E7%9A%84%E6%BA%90%E7%A0%81%0A%0A%60%60%60%0Avoid%20attachLists(List*%20const%20*%20addedLists%2C%20uint32_t%20addedCount)%20%7B%0A%20if%20(hasArray())%20%7B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2F%2F%E6%97%A7%E7%9A%84%E6%96%B9%E6%B3%95%E5%88%97%E8%A1%A8%E7%9A%84%E9%95%BF%E5%BA%A6%0A%20%20%20%20%20%20%20%20uint32_t%20oldCount%20%3D%20array()-%3Ecount%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2F%2F%E6%96%B0%E7%9A%84%E6%96%B9%E6%B3%95%E5%88%97%E8%A1%A8%E7%9A%84%E9%95%BF%E5%BA%A6%0A%20%20%20%20%20%20%20%20uint32_t%20newCount%20%3D%20oldCount%20%2B%20addedCount%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20setArray((array_t%20*)realloc(array()%2C%20array_t%3A%3AbyteSize(newCount)))%3B%0A%20%20%20%20%20%20%20%20array()-%3Ecount%20%3D%20newCount%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2F%2F%E4%BB%8EaddedCount%E7%9A%84%E5%81%8F%E7%A7%BB%E9%87%8F%E6%B7%BB%E5%8A%A0%E6%97%A7%E7%9A%84%E6%96%B9%E6%B3%95%E5%88%97%E8%A1%A8%0A%20%20%20%20%20%20%20%20memmove(array()-%3Elists%20%2B%20addedCount%2C%20array()-%3Elists%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20oldCount%20*%20sizeof(array()-%3Elists%5B0%5D))%3B%0A%20%20%20%20%20%20%20%20%2F%2F%E4%BB%8E%E5%BC%80%E5%A7%8B%E6%B7%BB%E5%8A%A0%E6%96%B0%E6%96%B9%E6%B3%95%E5%88%97%E8%A1%A8%0A%20%20%20%20%20%20%20%20memcpy(array()-%3Elists%2C%20addedLists%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20addedCount%20*%20sizeof(array()-%3Elists%5B0%5D))%3B%0A%20%20%20%20%20%20%20%20%7D%0A%7D%0A%0A%60%60%60%0A%0A%E4%BB%8E%E4%B8%8A%E9%9D%A2%E7%9A%84%E4%BB%A3%E7%A0%81%E4%B9%9F%E9%AA%8C%E8%AF%81%E4%BA%86%E6%88%91%E4%BB%AC%E4%B8%8A%E9%9D%A2%E6%89%80%E8%AF%B4%E7%9A%84%EF%BC%8C%E5%90%8C%E5%90%8D%E7%9A%84%E6%96%B9%E6%B3%95%E6%98%AF%E8%A6%86%E7%9B%96%E8%80%8C%E4%B8%8D%E6%98%AF%E6%9B%BF%E6%8D%A2%EF%BC%8Ccategory%E7%9A%84%E6%96%B9%E6%B3%95%E8%A2%AB%E6%94%BE%E5%88%B0%E4%BA%86%E6%96%B0%E6%96%B9%E6%B3%95%E5%88%97%E8%A1%A8%E7%9A%84%E5%89%8D%E9%9D%A2%0A%0A%0A%23%23%23%23%202.%20Category%E5%92%8CClass%20Extension%E7%9A%84%E5%8C%BA%E5%88%AB%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%0A%0AClass%20Extension%E5%9C%A8%E7%BC%96%E8%AF%91%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%AE%83%E7%9A%84%E6%95%B0%E6%8D%AE%E5%B0%B1%E5%B7%B2%E7%BB%8F%E5%8C%85%E5%90%AB%E5%9C%A8%E7%B1%BB%E4%BF%A1%E6%81%AF%E4%B8%AD%0ACategory%E6%98%AF%E5%9C%A8%E8%BF%90%E8%A1%8C%E6%97%B6%EF%BC%8C%E6%89%8D%E4%BC%9A%E5%B0%86%E6%95%B0%E6%8D%AE%E5%90%88%E5%B9%B6%E5%88%B0%E7%B1%BB%E4%BF%A1%E6%81%AF%E4%B8%AD%0A%0A%0A%23%23%23%23%203.%20load%E8%B0%83%E7%94%A8%E5%8E%9F%E7%90%86%0A%0A!%5Babe4b1036a1258ce8a0ef80b3d6d2143.png%5D(evernotecid%3A%2F%2FCFE27DEA-507B-4F51-A112-35468FF833F4%2Fappyinxiangcom%2F21790515%2FENResource%2Fp3064)%0A%0A!%5B365e7d418f1512ea3dfed15c33d18689.png%5D(evernotecid%3A%2F%2FCFE27DEA-507B-4F51-A112-35468FF833F4%2Fappyinxiangcom%2F21790515%2FENResource%2Fp3065)%0A%20%20%0A%0A%0A%23%23%23%23%204.%20load%E4%B8%8E%E7%B1%BB%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E5%8C%BA%E5%88%AB%0A%0Aload%E6%96%B9%E6%B3%95%E5%BA%95%E5%B1%82%E6%98%AF%E9%80%9A%E8%BF%87%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88%E7%9B%B4%E6%8E%A5%E8%B0%83%E7%94%A8%EF%BC%8C%E7%B1%BB%E6%96%B9%E6%B3%95%E9%80%9A%E8%BF%87objc_messageSend%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6%E8%B0%83%E7%94%A8%E3%80%82%0A%0A%0A%23%23%23%23%205.%20%E9%9D%A2%E8%AF%95%E9%A2%98%0A%0A%23%23%23%23%23%205.1%20Category%E6%9C%89load%E6%96%B9%E6%B3%95%E5%90%97%EF%BC%9F%20load%E6%96%B9%E6%B3%95%E6%98%AF%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E8%B0%83%E7%94%A8%EF%BC%9Fload%E6%96%B9%E6%B3%95%E8%83%BD%E7%BB%A7%E6%89%BF%E5%90%97%EF%BC%9F%0A*%20%E6%9C%89load%E6%96%B9%E6%B3%95%0A*%20load%E6%96%B9%E6%B3%95%E5%9C%A8runtime%E5%8A%A0%E8%BD%BD%E7%B1%BB%E3%80%81%E5%88%86%E7%B1%BB%E7%9A%84%E6%97%B6%E5%80%99%E8%B0%83%E7%94%A8%0A*%20load%E6%96%B9%E6%B3%95%E5%8F%AF%E4%BB%A5%E7%BB%A7%E6%89%BF%EF%BC%8C%E4%BD%86%E6%98%AF%E4%B8%80%E8%88%AC%E6%83%85%E5%86%B5%E4%B8%8B%E6%88%91%E4%BB%AC%E4%B8%8D%E4%BC%9A%E4%B8%BB%E5%8A%A8%E8%B0%83%E7%94%A8load%E6%96%B9%E6%B3%95%EF%BC%8C%E9%83%BD%E6%98%AF%E8%AE%A9%E7%B3%BB%E7%BB%9F%E8%87%AA%E5%8A%A8%E8%B0%83%E7%94%A8%E3%80%82%0A%0A%23%23%23%23%23%205.2%20load%E3%80%81initialize%E6%96%B9%E6%B3%95%E7%9A%84%E5%8C%BA%E5%88%AB%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E5%AE%83%E4%BB%AC%E5%9C%A8Category%E4%B8%AD%E7%9A%84%E8%B0%83%E7%94%A8%E9%A1%BA%E5%BA%8F%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E4%BB%A5%E5%8F%8A%E5%87%BA%E7%8E%B0%E7%BB%A7%E6%89%BF%E6%97%B6%E5%AE%83%E4%BB%AC%E4%B9%8B%E9%97%B4%E7%9A%84%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%0A%23%23%23%23%23%23%20load%E3%80%81initialize%E6%96%B9%E6%B3%95%E7%9A%84%E5%8C%BA%E5%88%AB%E6%98%AF%E4%BB%80%E4%B9%88%0A*%20%E8%B0%83%E7%94%A8%E6%96%B9%E5%BC%8F%0A1.%20%20%20load%E6%98%AF%E6%A0%B9%E6%8D%AE%E5%87%BD%E6%95%B0%E5%9C%B0%E5%9D%80%E7%9B%B4%E6%8E%A5%E8%B0%83%E7%94%A8%0A2.%20%20%20initialize%E6%98%AF%E9%80%9A%E8%BF%87objc_msgSend%E8%B0%83%E7%94%A8%0A*%20%E8%B0%83%E7%94%A8%E6%97%B6%E5%88%BB%0A1.%20%20%20load%E6%98%AF%E5%9C%A8runtime%E5%8A%A0%E8%BD%BD%E5%88%86%E7%B1%BB%E7%9A%84%E6%97%B6%E5%80%99%E8%B0%83%E7%94%A8%EF%BC%88%E5%8F%AA%E4%BC%9A%E8%B0%83%E7%94%A8%E4%B8%80%E6%AC%A1%EF%BC%89%0A2.%20%20%20initialize%E6%98%AF%E7%B1%BB%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%8E%A5%E6%94%B6%E5%88%B0%E6%B6%88%E6%81%AF%E7%9A%84%E6%97%B6%E5%80%99%E8%B0%83%E7%94%A8%EF%BC%8C%E6%AF%8F%E4%B8%80%E4%B8%AA%E7%B1%BB%E5%8F%AA%E4%BC%9Ainitialize%E4%B8%80%E6%AC%A1%EF%BC%88%E7%88%B6%E7%B1%BB%E7%9A%84initialize%E6%96%B9%E6%B3%95%E5%8F%AF%E8%83%BD%E4%BC%9A%E8%A2%AB%E8%B0%83%E7%94%A8%E5%A4%9A%E6%AC%A1%EF%BC%89%0A%0A%23%23%23%23%23%23%20load%E3%80%81initialize%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E9%A1%BA%E5%BA%8F%0A*%20load%0A1.%20%E5%85%88%E8%B0%83%E7%94%A8%E7%B1%BB%E7%9A%84load%0Aa.%E5%85%88%E7%BC%96%E8%AF%91%E7%9A%84%E7%B1%BB%EF%BC%8C%E4%BC%98%E5%85%88%E8%B0%83%E7%94%A8load%0Ab.%E8%B0%83%E7%94%A8%E5%AD%90%E7%B1%BB%E7%9A%84load%E4%B9%8B%E5%89%8D%EF%BC%8C%E4%BC%9A%E5%85%88%E8%B0%83%E7%94%A8%E7%88%B6%E7%B1%BB%E7%9A%84load%0A2.%20%E5%86%8D%E8%B0%83%E7%94%A8%E5%88%86%E7%B1%BB%E7%9A%84load%0Aa.%E5%85%88%E7%BC%96%E8%AF%91%E7%9A%84%E5%88%86%E7%B1%BB%EF%BC%8C%E4%BC%98%E5%85%88%E8%B0%83%E7%94%A8load%0A%0A*%20initialize%0A1.%20%E5%85%88%E5%88%9D%E5%A7%8B%E5%8C%96%E7%88%B6%E7%B1%BB%0A2.%20%E5%86%8D%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AD%90%E7%B1%BB%EF%BC%88%E5%8F%AF%E8%83%BD%E6%9C%80%E7%BB%88%E8%B0%83%E7%94%A8%E7%88%B6%E7%B1%BB%E7%9A%84initialize%E6%96%B9%E6%B3%95%EF%BC%89%0A%0A%0A%23%23%23%23%23%206.1%20Category%E8%83%BD%E5%90%A6%E7%9B%B4%E6%8E%A5%E6%B7%BB%E5%8A%A0%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F%EF%BC%9F%E5%A6%82%E6%9E%9C%E5%8F%AF%E4%BB%A5%EF%BC%8C%E5%A6%82%E4%BD%95%E7%BB%99Category%E6%B7%BB%E5%8A%A0%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F%EF%BC%9F%0A%0A%E4%B8%8D%E8%83%BD%E7%9B%B4%E6%8E%A5%E7%BB%99Category%E6%B7%BB%E5%8A%A0%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F%EF%BC%8C%E4%BD%86%E6%98%AF%E5%8F%AF%E4%BB%A5%E9%97%B4%E6%8E%A5%E5%AE%9E%E7%8E%B0%E5%88%86%E7%B1%BB%E6%9C%89%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F%E7%9A%84%E6%95%88%E6%9E%9C%E3%80%82%0A%0A%E5%88%86%E7%B1%BB%E7%9A%84%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84%E5%86%B3%E5%AE%9A%E4%BA%86%E5%AE%83%E4%B8%8D%E8%83%BD%E7%9B%B4%E6%8E%A5%E6%B7%BB%E5%8A%A0%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F%EF%BC%8C%E5%9B%A0%E4%B8%BA%E6%B2%A1%E6%9C%89%E6%95%B0%E7%BB%84%E6%9D%A5%E5%AD%98%E6%94%BE%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F%EF%BC%88%E6%B3%A8%E6%84%8F%E5%8C%BA%E5%88%86%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F%E5%92%8C%E5%B1%9E%E6%80%A7%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%89%EF%BC%8C%E8%80%8C%E4%BB%8E%E7%B1%BB%E7%9A%84%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84%E4%B8%AD%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%87%BAivars%EF%BC%88struct%20objc_ivar_list%20*%20_Nullable%20ivars%20OBJC2_UNAVAILABLE%3B%EF%BC%89%E6%98%AF%E5%AD%98%E6%94%BE%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F%E7%9A%84%E3%80%82%0A%0A%E4%BB%8E%E5%88%86%E7%B1%BB%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E7%9C%8B%E5%87%BA%EF%BC%8C%E5%85%B6%E4%B8%ADstruct%20property_list_t%20*instanceProperties%EF%BC%8C%E5%88%86%E7%B1%BB%E6%98%AF%E5%8F%AF%E4%BB%A5%E6%B7%BB%E5%8A%A0%E5%B1%9E%E6%80%A7%E7%9A%84%E3%80%82%0A%0A%60%60%60%0A%0A%E6%AF%8F%E4%B8%AA%E5%88%86%E7%B1%BB%E9%83%BD%E6%98%AF%E4%B8%80%E4%B8%AA_category_t%E7%B1%BB%E5%9E%8B%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93%EF%BC%9A%0Astruct%20category_t%20%7B%0A%20%20%20%20%23%E7%B1%BB%E5%90%8D%EF%BC%88%E6%8B%93%E5%B1%95%E7%9A%84%E7%B1%BB%EF%BC%89%0A%20%20%20%20const%20char%20*name%3B%0A%20%20%20%20%23%E7%B1%BB%0A%20%20%20%20classref_t%20cls%3B%0A%20%20%20%20%23category%E4%B8%AD%E6%89%80%E6%9C%89%E7%BB%99%E7%B1%BB%E6%B7%BB%E5%8A%A0%E7%9A%84%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%95%E7%9A%84%E5%88%97%E8%A1%A8(instanceMethods)%0A%20%20%20%20struct%20method_list_t%20*instanceMethods%3B%0A%20%20%20%20%23category%E4%B8%AD%E6%89%80%E6%9C%89%E6%B7%BB%E5%8A%A0%E7%9A%84%E7%B1%BB%E6%96%B9%E6%B3%95%E7%9A%84%E5%88%97%E8%A1%A8(classMethods)%0A%20%20%20%20struct%20method_list_t%20*classMethods%3B%0A%20%20%20%20%23category%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%89%80%E6%9C%89%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%88%97%E8%A1%A8(protocols)%0A%20%20%20%20struct%20protocol_list_t%20*protocols%3B%0A%20%20%20%20%23category%E4%B8%AD%E6%B7%BB%E5%8A%A0%E7%9A%84%E6%89%80%E6%9C%89%E5%B1%9E%E6%80%A7(instanceProperties)%0A%20%20%20%20struct%20property_list_t%20*instanceProperties%3B%0A%0A%20%20%20%20method_list_t%20*methodsForMeta(bool%20isMeta)%20%7B%0A%20%20%20%20%20%20%20%20if%20(isMeta)%20return%20classMethods%3B%0A%20%20%20%20%20%20%20%20else%20return%20instanceMethods%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20property_list_t%20*propertiesForMeta(bool%20isMeta)%20%7B%0A%20%20%20%20%20%20%20%20if%20(isMeta)%20return%20nil%3B%20%2F%2F%20classProperties%3B%0A%20%20%20%20%20%20%20%20else%20return%20instanceProperties%3B%0A%20%20%20%20%7D%0A%7D%3B%0A%0A%60%60%60%0A%0A%23%23%23%23%23%206.2%20%E5%AE%8C%E5%96%84%E4%BD%BF%E7%94%A8%E5%AD%97%E5%85%B8%E7%BB%99Category%E6%B7%BB%E5%8A%A0%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%0A%0A%60%60%60%0A%2F%2F%2F%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9A%E7%94%A8%E5%AD%97%E5%85%B8%E5%BB%BA%E7%AB%8Bself%E4%B8%8E%E5%80%BC%E7%9A%84%E5%85%B3%E7%B3%BB%0ANSMutableDictionary%20*weights_%3B%0A%0A-%20(void)setWeight%3A(float)weight%20%7B%0A%20%20%20%20%0A%20%20%20%20NSString%20*key%20%3D%20%5BNSString%20stringWithFormat%3A%40%22%25p%22%2Cself%5D%3B%0A%20%20%20%20weights_%5Bkey%5D%20%3D%20%40(weight)%3B%0A%7D%0A%0A-%20(float)weight%20%7B%0A%20%20%20%20%0A%20%20%20%20NSString%20*key%20%3D%20%5BNSString%20stringWithFormat%3A%40%22%25p%22%2Cself%5D%3B%0A%20%20%20%20return%20%5Bweights_%5Bkey%5D%20floatValue%5D%3B%0A%7D%0A%0A%60%60%60%0A%0A%3E%20%E5%AD%98%E5%9C%A8%E9%97%AE%E9%A2%98%EF%BC%9A%0A*%20%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98%EF%BC%88weights_%E5%85%A8%E5%B1%80%EF%BC%89%EF%BC%8C%E5%8F%AF%E8%83%BD%E5%AF%BC%E8%87%B4%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E9%97%AE%E9%A2%98%0A*%20%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%0A%0A%23%23%23%23%23%206.3%20Category%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%0A%60%60%60%0A%23import%20%22Student%2BTest.h%22%0A%23import%20%3Cobjc%2Fruntime.h%3E%0A%0A%40implementation%20Student%20(Test)%0A%0A%2F%2F%2Fkey%E7%9A%84%E5%86%99%E6%B3%951%2C%E6%B2%A1%E6%9C%89%E5%80%BC%EF%BC%8C%E5%AF%BC%E8%87%B4%E5%A4%9A%E4%B8%AA%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%E6%97%B6%E5%80%99%EF%BC%8C%E6%97%A0%E6%B3%95%E8%8E%B7%E5%8F%96%E5%88%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%80%BC%E3%80%82%0A%2F%2Fconst%20void%20*StuNameKey%3B%0A%2F%2Fconst%20void%20*StuGenderKey%3B%0A%0A%2F%2F%2Fkey%E7%9A%84%E5%86%99%E6%B3%952%2C%E5%A4%96%E7%95%8C%E9%80%9A%E8%BF%87extern%20const%20void%20*StuNameKey%3B%E5%8F%AF%E4%BB%A5%E9%9A%8F%E6%84%8F%E4%BF%AE%E6%94%B9%E5%80%BC%0A%2F%2F%2Fvoid%20*%E5%88%99%E4%B8%BA%E2%80%9C%E6%97%A0%E7%B1%BB%E5%9E%8B%E6%8C%87%E9%92%88%E2%80%9D%EF%BC%8Cvoid%20*%E5%8F%AF%E4%BB%A5%E6%8C%87%E5%90%91%E4%BB%BB%E4%BD%95%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%95%B0%E6%8D%AE%E3%80%82%0A%2F%2Fconst%20void%20*StuNameKey%20%3D%20%26StuNameKey%3B%0A%2F%2Fconst%20void%20*StuGenderKey%20%3D%20%26StuGenderKey%3B%0A%0A%2F%2F%2Fkey%E7%9A%84%E5%86%99%E6%B3%953%2Cstatic%E7%A1%AE%E4%BF%9D%E5%8F%AA%E8%83%BD%E5%86%85%E9%83%A8%E4%BD%BF%E7%94%A8%EF%BC%8C%E5%A4%96%E7%95%8C%E4%B8%8D%E5%BE%97%E4%BF%AE%E6%94%B9%0A%2F%2Fstatic%20const%20void%20*StuNameKey%20%3D%20%26StuNameKey%3B%0A%2F%2Fstatic%20const%20void%20*StuGenderKey%20%3D%20%26StuGenderKey%3B%0A%0A%2F%2F%2Fkey%E7%9A%84%E5%86%99%E6%B3%954%2Cconst%20void%20*%20_Nonnull%20key%EF%BC%8C%E8%AF%B4%E6%98%8E%E9%9C%80%E8%A6%81%E4%B8%80%E4%B8%AA%E5%9C%B0%E5%9D%80%EF%BC%88void%20*%EF%BC%89%E5%80%BC%EF%BC%8C%E6%89%80%E4%BB%A5%E6%B2%A1%E6%9C%89%E5%BF%85%E8%A6%81%E7%BB%99%E8%B5%8B%E5%80%BC%EF%BC%8C%E9%80%9A%E8%BF%87%26StuNameKey%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80%E5%8D%B3%E5%8F%AF%0A%2F%2Fstatic%20const%20void%20*StuNameKey%3B%0Astatic%20const%20void%20*StuGenderKey%3B%0A%0A%2F%2F%2Fkey%E7%9A%84%E5%86%99%E6%B3%955%2Ckey%E4%BC%A0%E4%B8%80%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%88%40%22name%22%2C%E7%9B%B4%E6%8E%A5%E5%86%99%E5%87%BA%E6%9D%A5%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%98%AF%E6%94%BE%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84%E5%B8%B8%E9%87%8F%E5%8C%BA%EF%BC%8C%E5%AE%83%E7%9A%84%E5%9C%B0%E5%9D%80%E6%98%AF%E4%B8%8D%E4%BC%9A%E5%8F%98%E7%9A%84%EF%BC%89%2Ckey%E5%AE%9E%E9%99%85%E4%B8%8A%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AA%E5%9C%B0%E5%9D%80%0A%23define%20StuNameKey%20%40%22name%22%0A%2F%2Fobjc_setAssociatedObject(self%2C%20StuNameKey%2C%20name%2C%20OBJC_ASSOCIATION_COPY_NONATOMIC)%3B%0A%2F%2Freturn%20objc_getAssociatedObject(self%2C%20StuNameKey)%3B%0A%0A%2F%2F%2Fkey%E7%9A%84%E5%86%99%E6%B3%956%2Ckey%E4%BC%A0%40selector(name)%3A%3A%3A%E6%8E%A8%E8%8D%90%0A%2F%2Fobjc_setAssociatedObject(self%2C%20%40selector(name)%2C%20name%2C%20OBJC_ASSOCIATION_COPY_NONATOMIC)%3B%0A%2F%2Freturn%20objc_getAssociatedObject(self%2C%20%40selector(name))%3B%0A%0A-%20(void)setName%3A(NSString%20*)name%20%7B%0A%2F%2FNSLog(%40%22%25%40%3AStuNameKey%3A%25p%22%2CNSStringFromSelector(_cmd)%2CStuNameKey)%3B%0A%2F*%0A%20objc_setAssociatedObject(id%20_Nonnull%20object%2C%20const%20void%20*%20_Nonnull%20key%2C%0A%20id%20_Nullable%20value%2C%20objc_AssociationPolicy%20policy)%0A%20object%3A%E5%85%B3%E8%81%94%E7%9A%84%E6%BA%90%E5%AF%B9%E8%B1%A1%0A%20key%3A%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%E7%9A%84key%EF%BC%8C%E4%BC%A0%E7%A9%BA%E4%BC%9A%E6%B8%85%E9%99%A4%E5%85%B3%E8%81%94%0A%20policy%3A%20%E5%85%B3%E8%81%94%E7%AD%96%E7%95%A5%0A%20*%2F%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%20%20objc_setAssociatedObject(self%2C%20StuNameKey%2C%20name%2C%20OBJC_ASSOCIATION_COPY_NONATOMIC)%3B%0A%7D%0A%0A-%20(NSString%20*)name%20%7B%0A%20%20%20%20%0A%20%20%20%20return%20objc_getAssociatedObject(self%2C%20StuNameKey)%3B%0A%7D%0A%0A-%20(void)setGender%3A(NSString%20*)gender%20%7B%0A%20%20%20%20%0A%20%20%20%20objc_setAssociatedObject(self%2C%20%26StuGenderKey%2C%20gender%2C%20OBJC_ASSOCIATION_COPY_NONATOMIC)%3B%0A%7D%0A%0A-%20(NSString%20*)gender%20%7B%0A%20%20%20%20%0A%20%20%20%20return%20objc_getAssociatedObject(self%2C%20%26StuGenderKey)%3B%0A%7D%0A%0A%40end%0A%0A%60%60%60%0A%0A*%20%E6%8E%A8%E8%8D%90%E5%86%99%E6%B3%95%EF%BC%9A%0A%60%60%60%0A-%20(void)setName%3A(NSString%20*)name%20%7B%0A%2F%2FNSLog(%40%22%25%40%3AStuNameKey%3A%25p%22%2CNSStringFromSelector(_cmd)%2CStuNameKey)%3B%0A%2F*%0A%20objc_setAssociatedObject(id%20_Nonnull%20object%2C%20const%20void%20*%20_Nonnull%20key%2C%0A%20id%20_Nullable%20value%2C%20objc_AssociationPolicy%20policy)%0A%20object%3A%E5%85%B3%E8%81%94%E7%9A%84%E6%BA%90%E5%AF%B9%E8%B1%A1%0A%20key%3A%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%E7%9A%84key%EF%BC%8C%E4%BC%A0%E7%A9%BA%E4%BC%9A%E6%B8%85%E9%99%A4%E5%85%B3%E8%81%94%0A%20policy%3A%20%E5%85%B3%E8%81%94%E7%AD%96%E7%95%A5%0A%20*%2F%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%20%20objc_setAssociatedObject(self%2C%20%40selector(name)%2C%20name%2C%20OBJC_ASSOCIATION_COPY_NONATOMIC)%3B%0A%7D%0A%0A-%20(NSString%20*)name%20%7B%0A%20%20%20%20%0A%20%20%20%20return%20objc_getAssociatedObject(self%2C%20%40selector(name))%3B%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%23%206.4%20Category%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%8E%9F%E7%90%86%0A%0A%60%60%60%0Avoid%20objc_setAssociatedObject(id%20object%2C%20const%20void%20*key%2C%20id%20value%2C%20objc_AssociationPolicy%20policy)%20%7B%0A%20%20%20%20_object_set_associative_reference(object%2C%20(void%20*)key%2C%20value%2C%20policy)%3B%0A%7D%0A%60%60%60%0A</center></body></html>